<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络协议栈五层模型</title>
    <style>
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #e9ecef;
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; margin: 0; overflow: hidden;
        }

        h2 { color: #333; margin: 10px 0 5px 0; }
        
        #stage-container {
            position: relative; width: 1200px; height: 550px; margin-top: 10px;
        }

        /* === 机箱与内部结构 === */
        .system-box {
            width: 360px; height: 460px;
            background: #212529;
            border-radius: 10px; border: 3px solid #343a40;
            position: absolute; top: 40px;
            display: flex; flex-direction: column;
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
            overflow: hidden; 
            z-index: 10;
        }
        .sys-title { text-align: center; color: #adb5bd; padding: 5px; font-weight: bold; border-bottom: 1px solid #495057; font-size: 12px; background: #1a1d20; z-index: 2;}

        .internal-layers { flex: 1; display: flex; flex-direction: column; position: relative; }
        .layer-zone {
            flex: 1; border-bottom: 1px dashed rgba(255,255,255,0.1);
            position: relative; display: flex; align-items: center; padding-left: 10px;
            font-size: 12px; font-weight: bold; text-transform: uppercase; color: rgba(255,255,255,0.3);
        }
        
        /* 彩色层级背景 */
        .lz-5 { background: rgba(232, 62, 140, 0.05); } .lz-4 { background: rgba(111, 66, 193, 0.05); }
        .lz-3 { background: rgba(13, 110, 253, 0.05); } .lz-2 { background: rgba(255, 193, 7, 0.05); }
        .lz-1 { background: rgba(25, 135, 84, 0.05); border-bottom: none;}

        /* 端口与组件 */
        .components-overlay { position: absolute; top: 30px; left: 0; width: 100%; height: calc(100% - 30px); pointer-events: none; }
        .ports-container { display: flex; justify-content: space-around; position: absolute; top: 18%; width: 100%; }
        .port-box { width: 60px; height: 40px; border: 2px dashed #6c757d; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; background: rgba(52, 58, 64, 0.8); border-radius: 5px; color: #adb5bd;}
        .port-box.active { border-color: #0d6efd; background: #0d6efd; color: white; }

        .eth-port {
            position: absolute; bottom: 30px; width: 20px; height: 40px; background: #495057; border: 2px solid #adb5bd;
            display: flex; align-items: center; justify-content: center; z-index: 3;
        }
        .eth-port::after { content: ''; width: 5px; height: 5px; background: #28a745; border-radius: 50%; box-shadow: 0 0 5px #28a745; }

        #sender-pc { left: 30px; }
        #sender-pc .eth-port { right: -12px; border-radius: 0 5px 5px 0; }
        
        #receiver-pc { right: 30px; opacity: 0.4; transition: opacity 0.5s; }
        #receiver-pc .eth-port { left: -12px; border-radius: 5px 0 0 5px; }
        #receiver-pc .layer-zone { justify-content: flex-end; padding-right: 10px; }

        /* === 路由器 === */
        #router {
            position: absolute; left: 50%; bottom: 20px; transform: translateX(-50%);
            width: 120px; height: 50px; background: #343a40; border: 2px solid #adb5bd; border-radius: 5px;
            display: flex; justify-content: center; align-items: center; color: #fff; font-weight: bold; font-size: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 10;
        }
        .ant { position: absolute; bottom: 100%; width: 5px; height: 30px; background: #6c757d; border-radius: 3px 3px 0 0; }
        .ant-1 { left: 20px; transform: rotate(-15deg); } .ant-2 { right: 20px; transform: rotate(15deg); }

        /* === 关键修复：波形动画 === */
        .waveform {
            position: absolute; width: 0; height: 30px;
            /* 使用 SVG 绘制更明显的正弦波 */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 20'%3E%3Cpath d='M0,10 Q10,0 20,10 T40,10' stroke='%2339ff14' stroke-width='4' fill='none'/%3E%3C/svg%3E");
            background-repeat: repeat-x; background-size: 40px 30px;
            display: none; z-index: 999; /* 确保在最顶层 */
            filter: drop-shadow(0 0 5px #39ff14); /* 发光效果 */
            pointer-events: none;
        }

        /* === 数据包 === */
        .packet {
            background: #95ec69; color: black; padding: 6px 12px; border-radius: 4px; font-weight: bold;
            position: absolute; transition: all 0.6s ease-in-out; z-index: 100; border: 2px solid white;
            display: flex; align-items: center; font-size: 12px; white-space: nowrap;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .header { font-size: 9px; color: white; padding: 3px 5px; margin-right: 2px; font-weight: bold; display: none; border-radius: 2px;}
        .h-port { background: #6f42c1; } .h-ip { background: #0d6efd; } .h-mac { background: #ffc107; color: black; }

        /* === 思维气泡 (新功能) === */
        .thought-bubble {
            position: absolute; background: white; color: #333; padding: 8px 12px; border-radius: 15px;
            font-size: 12px; font-weight: bold; border: 2px solid #0d6efd; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 200; opacity: 0; transition: opacity 0.3s; pointer-events: none; min-width: 120px; text-align: center;
        }
        /* 小尾巴 */
        .thought-bubble::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            border-width: 8px 8px 0; border-style: solid; border-color: #0d6efd transparent transparent transparent;
        }

        #phone-view {
            width: 180px; height: 300px; background: white; border: 5px solid #333; border-radius: 20px;
            position: absolute; left: 120px; top: 80px; z-index: 60;
            display: flex; flex-direction: column; box-shadow: 0 10px 35px rgba(0,0,0,0.4); transition: all 0.8s;
        }
        #receiver-app {
            width: 180px; height: 100px; background: white; border: 4px solid #333; border-radius: 10px;
            position: absolute; right: 120px; top: -110px; z-index: 60; display: none;
            flex-direction: column; align-items: center; justify-content: center; font-size: 14px; font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        #control-bar {
            position: fixed; bottom: 0; left: 0; right: 0; height: 70px;
            background: #fff; border-top: 1px solid #ddd; display: flex; justify-content: center; align-items: center; gap: 20px; z-index: 9999;
        }
        #step-desc { flex: 1; max-width: 700px; background: #f8f9fa; border-left: 5px solid #0d6efd; padding: 10px; font-size: 14px; border-radius: 4px;}
        button { padding: 10px 25px; font-size: 15px; background: #0d6efd; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:disabled { background: #ccc; }

    </style>
</head>
<body>

    <h2>网络五层协议栈解析</h2>
    
    <div id="stage-container">
        
        <div id="sender-pc" class="system-box">
            <div class="sys-title">Sender PC</div>
            <div class="internal-layers">
                <div class="layer-zone lz-5">L5 Application</div>
                <div class="layer-zone lz-4">L4 Transport</div>
                <div class="layer-zone lz-3">L3 Network</div>
                <div class="layer-zone lz-2">L2 Data Link</div>
                <div class="layer-zone lz-1">L1 Physical</div>
            </div>
            <div class="components-overlay">
                <div class="ports-container" id="sender-ports">
                    <div class="port-box active">WeChat<br>Port:80</div>
                </div>
            </div>
            <div class="eth-port"></div>
        </div>

        <div id="phone-view">
            <div style="background:#eee; padding:8px; font-weight:bold; font-size:12px; text-align:center;">手机微信</div>
            <div style="flex:1; background:#f5f5f5; padding:10px;">
                <div style="background:#95ec69; padding:8px; border-radius:5px; align-self:flex-end; float:right; display:none;" id="msg-bubble">你好</div>
            </div>
            <div style="padding:10px; background:#eee; text-align:center;">
                <button onclick="start()" id="btn-start" style="padding:5px 15px; font-size:12px;">发送</button>
            </div>
        </div>

        <div id="packet-send" class="packet" style="display: none;"><span>"你好"</span></div>
        <div id="packet-recv" class="packet" style="display: none;"></div>

        <div id="bubble" class="thought-bubble"></div>

        <div id="router">
            <div class="ant ant-1"></div><div class="ant ant-2"></div>Router
        </div>

        <div id="receiver-pc" class="system-box">
            <div class="sys-title">Receiver PC</div>
            <div class="internal-layers">
                <div class="layer-zone lz-5">L5 Application</div>
                <div class="layer-zone lz-4">L4 Transport</div>
                <div class="layer-zone lz-3">L3 Network</div>
                <div class="layer-zone lz-2">L2 Data Link</div>
                <div class="layer-zone lz-1">L1 Physical</div>
            </div>
            <div class="components-overlay">
                 <div class="ports-container" id="receiver-ports">
                    <div class="port-box active" id="rx-wechat-port">WeChat<br>Port:80</div>
                </div>
            </div>
            <div class="eth-port"></div>
            <div id="receiver-app">
                <div style="color:#07c160; margin-bottom:5px;">微信电脑版</div><div>收到消息："你好"</div>
            </div>
        </div>

        <div id="wave-1" class="waveform"></div>
        <div id="wave-2" class="waveform"></div>

    </div>

    <div id="control-bar">
        <div id="step-desc">请点击手机上的“发送”按钮开始。</div>
        <button id="btn-next" style="display: none;" onclick="nextStep()">下一步</button>
        <button onclick="location.reload()" style="background:#6c757d;">重置</button>
    </div>

    <script>
        let step = 0;
        const sPacket = document.getElementById('packet-send');
        const rPacket = document.getElementById('packet-recv');
        const bubble = document.getElementById('bubble');
        const desc = document.getElementById('step-desc');
        const btnNext = document.getElementById('btn-next');
        const phone = document.getElementById('phone-view');
        const receiverBox = document.getElementById('receiver-pc');
        const rxApp = document.getElementById('receiver-app');

        // 层级高度配置
        const LAYER_TOPS = { L5: 90, L4: 170, L3: 255, L2: 340, L1: 440 };

        function start() {
            document.getElementById('btn-start').disabled = true;
            document.getElementById('msg-bubble').style.display = 'block';
            desc.innerHTML = "<b>[Start]</b> 手机应用产生数据。";

            setTimeout(() => {
                phone.style.transform = "scale(0.6) translate(-400px, -200px)";
                phone.style.opacity = "0.3";
                
                setTimeout(() => {
                    sPacket.style.display = "flex";
                    // 初始位置：Sender L5
                    sPacket.style.left = "180px"; sPacket.style.top = LAYER_TOPS.L5 + "px";
                    desc.innerHTML = "<b>[L5 应用层]</b> 数据准备发送。";
                    btnNext.style.display = "inline-block";
                    step = 1;
                }, 800);
            }, 1000);
        }

        function showBubble(targetPacket, text) {
            bubble.innerText = text;
            bubble.style.opacity = 1;
            // 定位在数据包上方
            const rect = targetPacket.getBoundingClientRect();
            // 简单的坐标计算（减去容器偏移）
            bubble.style.left = (parseInt(targetPacket.style.left) - 20) + "px";
            bubble.style.top = (parseInt(targetPacket.style.top) - 60) + "px";
        }

        function hideBubble() {
            bubble.style.opacity = 0;
        }

        function nextStep() {
            // === Sender Steps ===
            if (step === 1) { // To L4
                desc.innerHTML = "<b>[Sender L4]</b> 添加端口号。";
                sPacket.style.top = LAYER_TOPS.L4 + "px";
                setTimeout(() => { addHeader(sPacket, 'h-port', 'Port:80'); sPacket.style.background = "#6f42c1"; sPacket.style.color="white"; }, 400);
                step++;
            }
            else if (step === 2) { // To L3 (Pre-header check)
                desc.innerHTML = "<b>[Sender L3]</b> 网络层决策环节。";
                sPacket.style.top = LAYER_TOPS.L3 + "px";
                
                // 关键修改：停留并显示气泡
                setTimeout(() => {
                    showBubble(sPacket, "Q: 发向哪里？\nA: 查表得 IP:1.1.1.1");
                }, 500);
                step++; // 需要多点一次下一步来确认
            }
            else if (step === 3) { // To L3 (Add header)
                hideBubble();
                desc.innerHTML = "<b>[Sender L3]</b> 确认目标 IP，添加 IP 头。";
                addHeader(sPacket, 'h-ip', 'IP:1.1.1.1'); sPacket.style.background = "#0d6efd";
                step++;
            }
            else if (step === 4) { // To L2
                desc.innerHTML = "<b>[Sender L2]</b> 添加 MAC 头。";
                sPacket.style.top = LAYER_TOPS.L2 + "px";
                setTimeout(() => { addHeader(sPacket, 'h-mac', 'MAC'); sPacket.style.background = "#ffc107"; sPacket.style.color="black"; }, 400);
                step++;
            }
            else if (step === 5) { // To L1 & Waveform
                desc.innerHTML = "<b>[Sender L1]</b> 物理发射！注意看波形。";
                sPacket.style.top = LAYER_TOPS.L1 + "px"; sPacket.style.left = "380px"; // 网口位置
                
                setTimeout(() => {
                    sPacket.style.opacity = "0"; // 包消失
                    
                    // 强制显示波形 1
                    const w1 = document.getElementById('wave-1'); 
                    w1.style.display = "block";
                    // 硬编码坐标确保可见：Sender Port (390, 480) -> Router (600, 520)
                    w1.style.left = '390px'; w1.style.top = '480px';
                    w1.style.transform = 'rotate(15deg)';
                    
                    w1.animate([{ width:'0px' }, { width:'220px' }], { duration: 1000, fill: 'forwards' });
                    
                    setTimeout(() => { document.getElementById('router').style.boxShadow = "0 0 20px #28a745"; }, 900);
                }, 600);
                step++;
            }

            // === Router ===
            else if (step === 6) { 
                desc.innerHTML = "<b>[Router]</b> 转发信号。";
                setTimeout(() => {
                    const w2 = document.getElementById('wave-2'); 
                    w2.style.display = "block";
                    // Router (600, 520) -> Receiver Port (810, 480)
                    w2.style.left = '640px'; w2.style.top = '530px';
                    w2.style.transform = 'rotate(-15deg)';
                    
                    w2.animate([{ width:'0px' }, { width:'220px' }], { duration: 1000, fill: 'forwards' });
                    
                    setTimeout(() => { receiverBox.style.opacity = "1"; receiverBox.style.boxShadow = "0 0 30px #0d6efd"; }, 900);
                }, 500);
                step++;
            }

            // === Receiver Steps (Upward) ===
            else if (step === 7) { // Re-appear at L1
                desc.innerHTML = "<b>[Receiver L1]</b> 接收波形，还原数据包。";
                rPacket.innerHTML = sPacket.innerHTML; // 复制
                rPacket.style.background = "#ffc107"; rPacket.style.color = "black";
                rPacket.style.display = "flex";
                rPacket.style.top = LAYER_TOPS.L1 + "px"; rPacket.style.left = "830px";
                step++;
            }
            else if (step === 8) { // Up to L2
                desc.innerHTML = "<b>[Receiver L2]</b> 链路层检查。";
                rPacket.style.top = LAYER_TOPS.L2 + "px";
                setTimeout(() => {
                    showBubble(rPacket, "MAC 匹配！\n这是给我的硬件");
                }, 500);
                step++;
            }
            else if (step === 9) { // L2 Action
                hideBubble();
                desc.innerHTML = "<b>[Receiver L2]</b> 拆除 MAC 头。";
                removeHeader(rPacket); rPacket.style.background = "#0d6efd"; rPacket.style.color = "white";
                step++;
            }
            else if (step === 10) { // Up to L3
                desc.innerHTML = "<b>[Receiver L3]</b> 网络层检查。";
                rPacket.style.top = LAYER_TOPS.L3 + "px";
                setTimeout(() => {
                    showBubble(rPacket, "IP 匹配！\n是发给我的系统");
                }, 500);
                step++;
            }
            else if (step === 11) { // L3 Action
                hideBubble();
                desc.innerHTML = "<b>[Receiver L3]</b> 拆除 IP 头。";
                removeHeader(rPacket); rPacket.style.background = "#6f42c1";
                step++;
            }
            else if (step === 12) { // Up to L4
                desc.innerHTML = "<b>[Receiver L4]</b> 运输层端口分发。";
                rPacket.style.top = LAYER_TOPS.L4 + "px";
                setTimeout(() => { 
                    removeHeader(rPacket); rPacket.style.background = "#95ec69"; rPacket.style.color = "black";
                    document.getElementById('rx-wechat-port').style.borderColor = "#95ec69"; // 高亮端口
                }, 400);
                step++;
            }
            else if (step === 13) { // Finish
                desc.innerHTML = "<b>[Receiver L5]</b> 交付应用。";
                rPacket.style.top = LAYER_TOPS.L5 + "px"; rPacket.style.left = "950px";
                setTimeout(() => {
                    rPacket.style.opacity = "0"; rxApp.style.display = "flex";
                    desc.innerHTML = "演示结束。";
                    btnNext.disabled = true;
                }, 800);
            }
        }

        function addHeader(el, cls, text) { const div = document.createElement('div'); div.className = `header ${cls}`; div.innerText = text; div.style.display = 'block'; el.insertBefore(div, el.firstChild); }
        function removeHeader(el) { const header = el.querySelector('.header'); if(header) header.remove(); }
    </script>
</body>
</html>