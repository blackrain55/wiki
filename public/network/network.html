<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络协议栈五层模型</title>
    <style>
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #e9ecef;
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; margin: 0; overflow: hidden;
        }

        h2 { color: #333; margin: 5px 0 5px 0; font-size: 18px; }
        
        /* === 核心舞台：宽度 800px === */
        #stage-container {
            position: relative; width: 800px; height: 550px; margin-top: 5px;
        }

        /* === 机箱样式 === */
        .system-box {
            width: 240px;
            height: 460px;
            background: #212529;
            border-radius: 10px; border: 3px solid #343a40;
            position: absolute; top: 40px;
            display: flex; flex-direction: column;
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            overflow: hidden; 
            z-index: 10;
        }
        .sys-title { text-align: center; color: #adb5bd; padding: 5px; font-weight: bold; border-bottom: 1px solid #495057; font-size: 14px; background: #1a1d20; z-index: 2;}

        .internal-layers { flex: 1; display: flex; flex-direction: column; position: relative; }
        .layer-zone {
            flex: 1; border-bottom: 1px dashed rgba(255,255,255,0.1);
            position: relative; display: flex; align-items: center; padding-left: 10px;
            font-size: 13px;
            font-weight: bold; text-transform: uppercase; color: rgba(255,255,255,0.3);
        }
        
        /* 彩色层级背景 */
        .lz-5 { background: rgba(232, 62, 140, 0.05); } .lz-4 { background: rgba(111, 66, 193, 0.05); }
        .lz-3 { background: rgba(13, 110, 253, 0.05); } .lz-2 { background: rgba(255, 193, 7, 0.05); }
        .lz-1 { background: rgba(25, 135, 84, 0.05); border-bottom: none;}

        .components-overlay { position: absolute; top: 30px; left: 0; width: 100%; height: calc(100% - 30px); pointer-events: none; }
        .ports-container { display: flex; justify-content: space-around; position: absolute; top: 18%; width: 100%; }
        .port-box { width: 50px; height: 35px; border: 2px dashed #6c757d; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 9px; background: rgba(52, 58, 64, 0.8); border-radius: 5px; color: #adb5bd;}
        .port-box.active { border-color: #0d6efd; background: #0d6efd; color: white; }

        .eth-port {
            position: absolute; bottom: 30px; width: 15px; height: 30px; background: #495057; border: 2px solid #adb5bd;
            display: flex; align-items: center; justify-content: center; z-index: 3;
        }
        .eth-port::after { content: ''; width: 4px; height: 4px; background: #28a745; border-radius: 50%; box-shadow: 0 0 5px #28a745; }

        /* === 位置调整 === */
        #sender-pc { left: 10px; }
        #sender-pc .eth-port { right: -10px; border-radius: 0 5px 5px 0; }
        
        #receiver-pc { right: 10px; opacity: 0.4; transition: opacity 0.5s; }
        #receiver-pc .eth-port { left: -10px; border-radius: 5px 0 0 5px; }
        #receiver-pc .layer-zone { justify-content: flex-end; padding-right: 10px; }

        /* === 路由器 === */
        #router {
            position: absolute; left: 50%; bottom: 25px; transform: translateX(-50%);
            width: 80px; height: 40px; background: #343a40; border: 2px solid #adb5bd; border-radius: 5px;
            display: flex; justify-content: center; align-items: center; color: #fff; font-weight: bold; font-size: 11px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 10;
        }
        .ant { position: absolute; bottom: 100%; width: 4px; height: 20px; background: #6c757d; border-radius: 3px 3px 0 0; }
        .ant-1 { left: 15px; transform: rotate(-15deg); } .ant-2 { right: 15px; transform: rotate(15deg); }

        .waveform {
            position: absolute; width: 0; height: 30px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 20'%3E%3Cpath d='M0,10 Q10,0 20,10 T40,10' stroke='%2339ff14' stroke-width='4' fill='none'/%3E%3C/svg%3E");
            background-repeat: repeat-x; background-size: 40px 30px;
            display: none; z-index: 999;
            filter: drop-shadow(0 0 5px #39ff14); pointer-events: none;
        }

        .packet {
            background: #95ec69; color: black; padding: 5px 8px; border-radius: 4px; font-weight: bold;
            position: absolute; transition: all 0.6s ease-in-out; z-index: 100; border: 2px solid white;
            display: flex; align-items: center; font-size: 11px; white-space: nowrap;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .header { font-size: 9px; color: white; padding: 2px 4px; margin-right: 2px; font-weight: bold; display: none; border-radius: 2px;}
        .h-port { background: #6f42c1; } .h-ip { background: #0d6efd; } .h-mac { background: #ffc107; color: black; }

        .thought-bubble {
            position: absolute; background: white; color: #333; padding: 6px 10px; border-radius: 15px;
            font-size: 11px; font-weight: bold; border: 2px solid #0d6efd; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 200; opacity: 0; transition: opacity 0.3s; pointer-events: none; min-width: 100px; text-align: center;
        }
        .thought-bubble::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            border-width: 8px 8px 0; border-style: solid; border-color: #0d6efd transparent transparent transparent;
        }

        #phone-view {
            width: 150px; height: 260px; background: white; border: 5px solid #333; border-radius: 20px;
            position: absolute; left: 60px; top: 80px; z-index: 60;
            display: flex; flex-direction: column; box-shadow: 0 10px 35px rgba(0,0,0,0.4); transition: all 0.8s;
        }
        #receiver-app {
            width: 150px; height: 90px; background: white; border: 4px solid #333; border-radius: 10px;
            position: absolute; right: 60px; top: -110px; z-index: 60; display: none;
            flex-direction: column; align-items: center; justify-content: center; font-size: 13px; font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* ========================================= */
        /* === NEW: 紧凑型提示条 (Toast) 样式开始 === */
        /* ========================================= */
        .toast-box {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            
            /* 布局核心：紧凑排列 */
            display: flex;
            align-items: center;
            justify-content: center; 
            gap: 15px; /* 文字和按钮的间距 */
            
            /* 外观 */
            padding: 8px 16px;
            background-color: rgba(40, 40, 40, 0.95);
            color: #fff;
            border-radius: 50px; /* 胶囊圆角 */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            
            font-size: 14px;
            z-index: 9999;
            
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        /* 显示状态 */
        .toast-box.show {
            opacity: 1;
            visibility: visible;
            bottom: 40px; /* 稍微上浮 */
        }

        /* 描述文字样式 (替代原来的 #step-desc div) */
        #step-desc {
            max-width: 400px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 按钮组 */
        .toast-buttons {
            display: flex;
            gap: 8px; /* 按钮之间紧凑 */
        }

        /* 按钮通用 */
        .toast-btn {
            border: none;
            outline: none;
            padding: 4px 12px;
            font-size: 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: 500;
        }

        /* 下一步按钮 (绿) */
        .toast-confirm {
            background-color: #4CAF50;
            color: white;
        }
        .toast-confirm:hover { background-color: #43A047; }
        
        /* 重置按钮 (灰) */
        .toast-cancel {
            background-color: #757575;
            color: white;
        }
        .toast-cancel:hover { background-color: #616161; }
        /* === NEW: 紧凑型提示条 样式结束 === */

    </style>
</head>
<body>

    <h2>网络五层协议栈解析</h2>
    
    <div id="stage-container">
        
        <div id="sender-pc" class="system-box">
            <div class="sys-title">Sender PC</div>
            <div class="internal-layers">
                <div class="layer-zone lz-5">L5 Application</div>
                <div class="layer-zone lz-4">L4 Transport</div>
                <div class="layer-zone lz-3">L3 Network</div>
                <div class="layer-zone lz-2">L2 Data Link</div>
                <div class="layer-zone lz-1">L1 Physical</div>
            </div>
            <div class="components-overlay">
                <div class="ports-container" id="sender-ports">
                    <div class="port-box active">WeChat<br>Port:80</div>
                </div>
            </div>
            <div class="eth-port"></div>
        </div>

        <div id="phone-view">
            <div style="background:#eee; padding:8px; font-weight:bold; font-size:12px; text-align:center;">手机微信</div>
            <div style="flex:1; background:#f5f5f5; padding:10px;">
                <div style="background:#95ec69; padding:8px; border-radius:5px; align-self:flex-end; float:right; display:none;" id="msg-bubble">你好</div>
            </div>
            <div style="padding:10px; background:#eee; text-align:center;">
                <button onclick="start()" id="btn-start" style="padding:5px 15px; font-size:12px; background:#07c160; color:white; border:none; border-radius:4px; cursor:pointer;">发送</button>
            </div>
        </div>

        <div id="packet-send" class="packet" style="display: none;"><span>"你好"</span></div>
        <div id="packet-recv" class="packet" style="display: none;"></div>

        <div id="bubble" class="thought-bubble"></div>

        <div id="router">
            <div class="ant ant-1"></div><div class="ant ant-2"></div>Router
        </div>

        <div id="receiver-pc" class="system-box">
            <div class="sys-title">Receiver PC</div>
            <div class="internal-layers">
                <div class="layer-zone lz-5">L5 Application</div>
                <div class="layer-zone lz-4">L4 Transport</div>
                <div class="layer-zone lz-3">L3 Network</div>
                <div class="layer-zone lz-2">L2 Data Link</div>
                <div class="layer-zone lz-1">L1 Physical</div>
            </div>
            <div class="components-overlay">
                 <div class="ports-container" id="receiver-ports">
                    <div class="port-box active" id="rx-wechat-port">WeChat<br>Port:80</div>
                </div>
            </div>
            <div class="eth-port"></div>
            <div id="receiver-app">
                <div style="color:#07c160; margin-bottom:5px;">微信电脑版</div><div>收到消息："你好"</div>
            </div>
        </div>

        <div id="wave-1" class="waveform"></div>
        <div id="wave-2" class="waveform"></div>

    </div>

    <div id="toast" class="toast-box show"> <span id="step-desc">请点击手机上的“发送”按钮开始。</span>
        
        <div class="toast-buttons">
            <button id="btn-next" class="toast-btn toast-confirm" style="display: none;" onclick="nextStep()">下一步</button>
            
            <button class="toast-btn toast-cancel" onclick="location.reload()">重置</button>
        </div>
    </div>

    <script>
        let step = 0;
        const sPacket = document.getElementById('packet-send');
        const rPacket = document.getElementById('packet-recv');
        const bubble = document.getElementById('bubble');
        const desc = document.getElementById('step-desc');
        const btnNext = document.getElementById('btn-next');
        const phone = document.getElementById('phone-view');
        const receiverBox = document.getElementById('receiver-pc');
        const rxApp = document.getElementById('receiver-app');

        const LAYER_TOPS = { L5: 90, L4: 170, L3: 255, L2: 340, L1: 440 };

        function start() {
            document.getElementById('btn-start').disabled = true;
            document.getElementById('msg-bubble').style.display = 'block';
            desc.innerHTML = "<b>[Start]</b> 手机应用产生数据。";

            setTimeout(() => {
                // 适配紧凑布局的动画位移
                phone.style.transform = "scale(0.6) translate(-100px, -200px)";
                phone.style.opacity = "0.3";
                
                setTimeout(() => {
                    sPacket.style.display = "flex";
                    // 修正坐标：Sender宽度240，中心约120，加Left偏移10 = 130
                    sPacket.style.left = "80px"; // 相对 Sender 内部位置视觉调整
                    sPacket.style.top = LAYER_TOPS.L5 + "px";
                    desc.innerHTML = "<b>[L5 应用层]</b> 数据准备发送。";
                    btnNext.style.display = "inline-block"; // 显示下一步按钮
                    step = 1;
                }, 800);
            }, 1000);
        }

        function showBubble(targetPacket, text) {
            bubble.innerText = text;
            bubble.style.opacity = 1;
            const rect = targetPacket.getBoundingClientRect();
            // 简单气泡跟随
            bubble.style.left = (parseInt(targetPacket.style.left) - 10) + "px";
            bubble.style.top = (parseInt(targetPacket.style.top) - 55) + "px";
        }

        function hideBubble() { bubble.style.opacity = 0; }

        function nextStep() {
            if (step === 1) { // To L4
                desc.innerHTML = "<b>[Sender L4]</b> 添加端口号。";
                sPacket.style.top = LAYER_TOPS.L4 + "px";
                setTimeout(() => { addHeader(sPacket, 'h-port', 'Port:80'); sPacket.style.background = "#6f42c1"; sPacket.style.color="white"; }, 400);
                step++;
            }
            else if (step === 2) { // To L3 Check
                desc.innerHTML = "<b>[Sender L3]</b> 网络层决策环节。";
                sPacket.style.top = LAYER_TOPS.L3 + "px";
                setTimeout(() => { showBubble(sPacket, "Q: 发向哪里？\nA: 查表得 IP:1.1.1.1"); }, 500);
                step++;
            }
            else if (step === 3) { // To L3 Add
                hideBubble();
                desc.innerHTML = "<b>[Sender L3]</b> 确认目标 IP，添加 IP 头。";
                addHeader(sPacket, 'h-ip', 'IP:1.1.1.1'); sPacket.style.background = "#0d6efd";
                step++;
            }
            else if (step === 4) { // To L2
                desc.innerHTML = "<b>[Sender L2]</b> 添加 MAC 头。";
                sPacket.style.top = LAYER_TOPS.L2 + "px";
                setTimeout(() => { addHeader(sPacket, 'h-mac', 'MAC'); sPacket.style.background = "#ffc107"; sPacket.style.color="black"; }, 400);
                step++;
            }
            else if (step === 5) { // To L1 & Waveform
                desc.innerHTML = "<b>[Sender L1]</b> 物理发射！注意看波形。";
                sPacket.style.top = LAYER_TOPS.L1 + "px"; 
                // 修正坐标：Sender边缘
                sPacket.style.left = "240px"; 
                
                setTimeout(() => {
                    sPacket.style.opacity = "0"; 
                    const w1 = document.getElementById('wave-1'); 
                    w1.style.display = "block";
                    // 修正波形1坐标：Sender(250) -> Router(360)
                    w1.style.left = '255px'; w1.style.top = '480px';
                    w1.style.transform = 'rotate(12deg)';
                    w1.animate([{ width:'0px' }, { width:'140px' }], { duration: 1000, fill: 'forwards' });
                    
                    setTimeout(() => { document.getElementById('router').style.boxShadow = "0 0 20px #28a745"; }, 900);
                }, 600);
                step++;
            }
            else if (step === 6) { // Router -> Receiver
                desc.innerHTML = "<b>[Router]</b> 转发信号。";
                setTimeout(() => {
                    const w2 = document.getElementById('wave-2'); 
                    w2.style.display = "block";
                    // 修正波形2坐标：Router(440) -> Receiver(550)
                    w2.style.left = '430px'; w2.style.top = '515px';
                    w2.style.transform = 'rotate(-12deg)';
                    w2.animate([{ width:'0px' }, { width:'140px' }], { duration: 1000, fill: 'forwards' });
                    
                    setTimeout(() => { receiverBox.style.opacity = "1"; receiverBox.style.boxShadow = "0 0 30px #0d6efd"; }, 900);
                }, 500);
                step++;
            }
            else if (step === 7) { // Re-appear at Receiver L1
                desc.innerHTML = "<b>[Receiver L1]</b> 接收波形，还原数据包。";
                rPacket.innerHTML = sPacket.innerHTML; 
                rPacket.style.background = "#ffc107"; rPacket.style.color = "black";
                rPacket.style.display = "flex";
                // 修正坐标：Receiver 内部
                rPacket.style.top = LAYER_TOPS.L1 + "px"; rPacket.style.left = "560px";
                step++;
            }
            else if (step === 8) { // Up to L2
                desc.innerHTML = "<b>[Receiver L2]</b> 链路层检查。";
                rPacket.style.top = LAYER_TOPS.L2 + "px";
                setTimeout(() => { showBubble(rPacket, "MAC 匹配！\n这是给我的硬件"); }, 500);
                step++;
            }
            else if (step === 9) { 
                hideBubble();
                desc.innerHTML = "<b>[Receiver L2]</b> 拆除 MAC 头。";
                removeHeader(rPacket); rPacket.style.background = "#0d6efd"; rPacket.style.color = "white";
                step++;
            }
            else if (step === 10) { 
                desc.innerHTML = "<b>[Receiver L3]</b> 网络层检查。";
                rPacket.style.top = LAYER_TOPS.L3 + "px";
                setTimeout(() => { showBubble(rPacket, "IP 匹配！\n是发给我的系统"); }, 500);
                step++;
            }
            else if (step === 11) { 
                hideBubble();
                desc.innerHTML = "<b>[Receiver L3]</b> 拆除 IP 头。";
                removeHeader(rPacket); rPacket.style.background = "#6f42c1";
                step++;
            }
            else if (step === 12) { 
                desc.innerHTML = "<b>[Receiver L4]</b> 运输层端口分发。";
                rPacket.style.top = LAYER_TOPS.L4 + "px";
                setTimeout(() => { 
                    removeHeader(rPacket); rPacket.style.background = "#95ec69"; rPacket.style.color = "black";
                    document.getElementById('rx-wechat-port').style.borderColor = "#95ec69"; 
                }, 400);
                step++;
            }
            else if (step === 13) { 
                desc.innerHTML = "<b>[Receiver L5]</b> 交付应用。";
                rPacket.style.top = LAYER_TOPS.L5 + "px"; rPacket.style.left = "650px";
                setTimeout(() => {
                    rPacket.style.opacity = "0"; rxApp.style.display = "flex";
                    desc.innerHTML = "演示结束。";
                    btnNext.disabled = true;
                }, 800);
            }
        }

        function addHeader(el, cls, text) { const div = document.createElement('div'); div.className = `header ${cls}`; div.innerText = text; div.style.display = 'block'; el.insertBefore(div, el.firstChild); }
        function removeHeader(el) { const header = el.querySelector('.header'); if(header) header.remove(); }
    </script>
</body>
</html>